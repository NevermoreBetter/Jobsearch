name: Next.js CI/CD
on:
 push:
  branches: [main]
 pull_request:
  branches: [main]

jobs:
 build:
  runs-on: ubuntu-latest

  strategy:
   matrix:
    node-version: [14.x, 16.x]

  steps:
   - uses: actions/checkout@v3
   - name: Use Node.js ${{ matrix.node-version }}
     uses: actions/setup-node@v3
     with:
      node-version: ${{ matrix.node-version }}

   - name: Install dependencies
     run: npm ci

   - name: Build
     run: npm run build

   - name: Run tests
     run: npm test

   - name: Lint
     run: npm run lint

 deploy:
  needs: build
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v3
   - name: Use Node.js 16.x
     uses: actions/setup-node@v3
     with:
      node-version: "16.x"

   - name: Install dependencies
     run: npm ci

   - name: Build
     run: npm run build

   - name: Deploy to Vercel
     env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
     run: npx vercel --prod --token=$VERCEL_TOKEN
